name: Unit Tests and Code Coverage

on:
    pull_request:
        branches: [main]

jobs:
    vitest-tests:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v2
            - name: Set up Node.js environment
              uses: actions/setup-node@v3
              with:
                  node-version: "16"

            - name: Test
              run: |
                  npm install
                  npm run test:coverage

            - name: Upload test coverage report
              uses: codecov/codecov-action@v2
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}

            - name: Check minimum code coverage
              uses: andymartinz/github-actions-go-version@v2.3.0
              with:
                  go-version: 1.18

            - name: Fail if coverage decreases
              run: |
                  previous_coverage=$(curl -sSL https://codecov.io/gh/YOUR_GITHUB_USERNAME/YOUR_REPOSITORY_NAME/branch/main)
                  current_coverage=$(curl -sSL https://codecov.io/gh/YOUR_GITHUB_USERNAME/YOUR_REPOSITORY_NAME/branch/main)
                  if [[ "$current_coverage" -lt "$previous_coverage" ]]; then
                    echo "ERROR: Code coverage decreased from $previous_coverage% to $current_coverage%."
                    exit 1
                  fi
